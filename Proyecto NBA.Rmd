---
title: "Proyecto 2"
author: "Carlos Angel"
date: "2025-05-25"
output: html_document
---


```{r setup, include=FALSE}
library(dplyr)
library(fastDummies)
library(psych)
library(fmsb)  
library(corrplot)
library(tidyr)
library(broom)
library(sigr)
library(ggplot2)
library(WVPlots)
library(Metrics)
library(e1071)
library(weights)
library(corrplot)
library(tidyverse)
library(rpart)
library(rpart.plot)
library(caret)
library(e1071)
library(readxl)
library(writexl)
library(lubridate)
library(arules)
library(purrr)
library(cluster)

setwd("C:/Users/carlo/OneDrive/Escritorio/data mining/Proyecto_2/Proyecto_unsupervised_learning")

df <- read.csv("nba_players_2023_clustering (1).csv")

df <- df %>%
  mutate(region = case_when(
    nationality == "USA" ~ "America del Norte",
    nationality == "Canada" ~ "America del Norte",
    nationality == "Mexico" ~ "America del Norte",
    nationality == "Australia" ~ "Oceania",
    nationality == "USA/Australia" ~ "America del Norte / Oceania",
    nationality == "Japan" ~ "Asia",
    nationality == "Finland" ~ "Europa",
    nationality == "Greece" ~ "Europa",
    nationality == "Nigeria" ~ "Africa",
    nationality == "Cameroon" ~ "Africa",
    TRUE ~ "Otra"
  ))

df <- df %>%
  mutate(rendimiento_por_minuto = (points_per_game + 
                                    assists_per_game + 
                                    rebounds_per_game) / minutes_played_per_game)

df <- df %>%
  mutate(nivel_jugador = case_when(
    rendimiento_por_minuto >= 1.2 ~ "Élite",
    rendimiento_por_minuto >= 1.0 ~ "Alto",
    rendimiento_por_minuto >= 0.75 ~ "Promedio",
    rendimiento_por_minuto >= 0.6 ~ "Bajo",
    TRUE ~ "Muy bajo"
  ))

df$nivel_jugador <- factor(df$nivel_jugador,
                           levels = c("Muy bajo", "Bajo", "Promedio", "Alto", "Élite"))

  
summary(df)

equipos <- c(
  "Orlando Magic", "Milwaukee Bucks", "Washington Wizards", "Phoenix Suns",
  "Miami Heat", "Milwaukee Bucks", "Philadelphia 76ers", "New York Knicks",
  "Sacramento Kings", "Washington Wizards", "Toronto Raptors", "Milwaukee Bucks",
  "Boston Celtics", "Boston Celtics", "New York Knicks", "Orlando Magic",
  "Utah Jazz", "Phoenix Suns", "Dallas Mavericks", "Los Angeles Lakers",
  "Oklahoma City Thunder", "Oklahoma City Thunder", "Golden State Warriors",
  "Dallas Mavericks", "Atlanta Hawks", "Chicago Bulls", "Phoenix Suns",
  "Charlotte Hornets", "Sacramento Kings", "Utah Jazz", "New York Knicks",
  "Oklahoma City Thunder", "Miami Heat", "Dallas Mavericks", "Memphis Grizzlies",
  "Los Angeles Clippers", "Dallas Mavericks", "Atlanta Hawks", "Brooklyn Nets",
  "Detroit Pistons", "Philadelphia 76ers", "San Antonio Spurs", "Dallas Mavericks",
  "Dallas Mavericks", "Chicago Bulls", "Boston Celtics", "Phoenix Suns",
  "Los Angeles Lakers", "Atlanta Hawks", "Phoenix Suns"
)


# Crear columna conferencia
df <- df %>%
  mutate(conferencia = case_when(
    team %in% c("Orlando Magic", "Milwaukee Bucks", "Washington Wizards",
                "Miami Heat", "Philadelphia 76ers", "New York Knicks",
                "Toronto Raptors", "Boston Celtics", "Atlanta Hawks",
                "Chicago Bulls", "Charlotte Hornets", "Brooklyn Nets",
                "Detroit Pistons") ~ "Eastern Conference",
    team %in% c("Phoenix Suns", "Sacramento Kings", "Utah Jazz",
                "Dallas Mavericks", "Los Angeles Lakers", "Oklahoma City Thunder",
                "Golden State Warriors", "Memphis Grizzlies",
                "Los Angeles Clippers", "San Antonio Spurs") ~ "Western Conference",
    TRUE ~ NA_character_  # Por si hay algún equipo que no esté listado
  ))

write.csv(df, file = "df3.csv", row.names = FALSE)

```
## Exploracion de datos 

Preguntas de exploracion: 

a. Cuál es la distribución de las variables. 

b. ¿Qué relación existe entre puntos, asistencias, rebotes por partida con la cantidad de minutos. 

c. ¿Qué relación existe entre puntos, asistencias, rebotes por partida con la edad. 

d. Cuantos hay en cada clasificacion de rendimiento por minuto. 

e. cuales son los jugadores en el nivel elite 

f. como esta distribuido el rendimiento por minuto por conferencia 

```{r Exploracion de datos, include=TRUE }
  
  
str(df)

glimpse(df)

summary(df)

# Distribucion de edad 

ggplot(df, aes(x = age)) +
  geom_histogram(bins = 10, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Distribucion de edad", 
       y = "Frecuencia", 
       x = "Edad")

# Distribucion de minutos por partido

ggplot(df, aes(x = minutes_played_per_game)) +
  geom_histogram(bins = 10, fill = "yellow", color = "black") +
  theme_minimal() +
  labs(title = "Distribucion de minutos por partido", 
       y = "Frecuencia", 
       x = "minutos por partido")

ggplot(df, aes(x = "", y = minutes_played_per_game)) ++
  geom_boxplot(fill = "yellow", color = "black") +
  theme_minimal() +
  labs(title = "Distribución de minutos por partido", 
       y = "Minutos por partido", 
       x = "") +
  coord_cartesian(ylim = c(0, max(df$minutes_played_per_game, na.rm = TRUE)))


# Distribucion de asistencias por partido

ggplot(df, aes(x = assists_per_game)) +
  geom_histogram(bins = 10, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Distribucion de asistencias por partido", 
       y = "Frecuencia", 
       x = "asistencias por partido")

# Distribucion de rebotes por partido

ggplot(df, aes(x = rebounds_per_game)) +
  geom_histogram(bins = 10, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Distribucion de rebotes por partido", 
       y = "Frecuencia", 
       x = "rebotes por partido")

# Distribucion de puntos por partido

ggplot(df, aes(x = points_per_game)) +
  geom_histogram(bins = 10, fill = "green", color = "black") +
  theme_minimal() +
  labs(title = "Distribucion de puntos por partido", 
       y = "Frecuencia", 
       x = "puntos por partido")

# pregunta 2. 

ggplot(df, aes(x = minutes_played_per_game, y = points_per_game)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "blue") +
  theme_minimal() +
  labs(title = "Relación entre minutos y puntos por partido",
       x = "Minutos por partido",
       y = "Puntos por partido")


ggplot(df, aes(x = minutes_played_per_game, y = assists_per_game)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "purple") +
  theme_minimal() +
  labs(title = "Relación entre minutos y asistencias por partido",
       x = "Minutos por partido",
       y = "Asistencias por partido")


ggplot(df, aes(x = minutes_played_per_game, y = rebounds_per_game)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "green") +
  theme_minimal() +
  labs(title = "Relación entre minutos y rebotes por partido",
       x = "Minutos por partido",
       y = "Rebotes por partido")

df_numeric <- df %>% select(where(is.numeric))

# Pregunta 3: 

ggplot(df, aes(x = age, y = points_per_game)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "blue") +
  theme_minimal() +
  labs(title = "Relación entre edad y puntos por partido",
       x = "Edad", y = "Puntos por partido")

ggplot(df, aes(x = age, y = assists_per_game)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "darkgreen") +
  theme_minimal() +
  labs(title = "Relación entre edad y asistencias por partido",
       x = "Edad", y = "Asistencias por partido")

ggplot(df, aes(x = age, y = rebounds_per_game)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", color = "purple") +
  theme_minimal() +
  labs(title = "Relación entre edad y rebotes por partido",
       x = "Edad", y = "Rebotes por partido")


# Pregunta 4. 

ggplot(df, aes(x = nivel_jugador, fill = nivel_jugador)) +
  geom_bar() +
  scale_fill_manual(values = c(
    "Muy bajo" = "#d73027",    
    "Bajo" = "#fc8d59",        
    "Promedio" = "#fee08b",    
    "Alto" = "#91cf60",        
    "Élite" = "#1a9850"        
  )) +
  labs(title = "Distribución de niveles de jugadores por eficiencia",
       x = "Nivel de jugador", y = "Cantidad de jugadores") +
  theme_minimal()

# jugadores con nivel elite 

df_elite = df %>% filter(nivel_jugador == "Élite")

## Otras preguntas: 


ggplot(df, aes(x = conferencia, y= rendimiento_por_minuto, fill = conferencia)) +
  geom_boxplot() +
  theme_classic() +
  labs(title = "rendimiento por minuto de cada conferencia",
       x = "conferencia", 
       y = "rendimiento por minuto")


# correlacion entre las variables. 
cor_matrix <- cor(df_numeric, use = "complete.obs")


corrplot(cor_matrix, method = "color", type = "upper",
         tl.col = "black", tl.srt = 45,
         addCoef.col = "black", # mostrar coeficientes
         number.cex = 0.7,
         col = colorRampPalette(c("red", "white", "blue"))(200))

write.csv(df, "df2.csv", fileEncoding = "UTF-8", row.names = FALSE)
```

Respuestas textuales (analisis de graficas): 

a) Distribuciones 

i) Vemos que la distibucion de la edad es variada con un sesgo en la derecha. La edad minima es de 19 y la media de edad es de 35.55. Existe un gran cantidad de personas con 30 años. 

ii) La distirbucion del monto tiene un sesgo hacia la derecha de igual manera y observamos que el credito promedio es de 3271 sin embargo la mediana es de 2320 por lo que la media puede estar muy influenciada por los valores atipicos de arriba 

iii) La distribucion de duracion de igual forma tiene un sesgo hacia la derecha, podemos observar que el tiempo promedio de un credito es de 21 meses y que el maximo de tiempo es de 72. 

b) Podemos observar que la relacion entre duracion y monto del credito es positiva esto quiere decir que mientras mas grande sea la duracion mas grande sera el monto del credito y viceversa. 

c) Se puede observar que no hay relacion entre el monto del credito y la edad. 

d) Se puede observar que no hay relacion entre la duracion del credito y la edad.

e) Se puede observar que el proposito del credito y la cantidad de este tienen relacion ya que, segun el proposito la cantidad de monto es superior. Por ejemplo: los creditos de domestic apillances se caracterizan por tener un monto bajo

f) Vemos que la distribucion segun el sexo mantienen los comportamientos antes mencionados sin embargo, los creditos de los hombres son menos predecibles ya que, tienen mas datos atipicos con distintos propositos. 

g) La casa que tiene la persona no tiene relacion con el monto del credito. 

G2) El tipo de la cuenta no tiene relacion con el monto del credito  

## Clusterizacion. 


```{r algoritmo apriori de reglas de asociación , include=TRUE }

set.seed(365)

cat_vars <- names(df)[sapply(df, function(x) is.factor(x) || is.character(x))]

df_dummies <- dummy_cols(df, 
                         select_columns = cat_vars, 
                         remove_selected_columns = TRUE,
                         remove_first_dummy = FALSE)

df_dummies$X = NULL

num_cols <- sapply(df_dummies, is.numeric) & !grepl("_", names(df_dummies))

df_scaled <- df_dummies

df_scaled[, num_cols] <- lapply(df_dummies[, num_cols], function(x) {
  if (max(x, na.rm = TRUE) == min(x, na.rm = TRUE)) {
    return(rep(0, length(x)))  # evita división por cero si todos los valores son iguales
  } else {
    return((x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE)))
  }
})


df_scaled[is.na(df_scaled)] = 0

tot_withinss <- map_dbl(2:10,  function(k){
  model <- kmeans(x = df_scaled, centers = k)
  model$tot.withinss
})


elbow_df <- data.frame(
  k = 2:10 ,
  tot_withinss = tot_withinss
)


ggplot(elbow_df, aes(x = k, y = tot_withinss)) +
  geom_line() +
  scale_x_continuous(breaks = 2:10)


sil_width <- map_dbl(2:10,  function(k){
  model <- pam(x = df_scaled, k = k)
  model$silinfo$avg.width
})


sil_df <- data.frame(
  k = 2:10,
  sil_width = sil_width
)

ggplot(sil_df, aes(x = k, y = sil_width)) +
  geom_line() +
  scale_x_continuous(breaks = 2:10)


model_customers <- kmeans(df_scaled, centers = 5)


cluster_k <- model_customers$cluster


segment_customers_k = cbind(df_scaled, cluster_k)

segment_customers_k2 = cbind(df, cluster_k)

df = cbind(df, cluster_k)


count(segment_customers_k, cluster_k)



Resumen_K = segment_customers_k %>% 
  group_by(cluster_k) %>% 
  summarise_all(funs(mean(.)))

Resumen_K


ggplot(df, aes(x = factor(cluster_k), y = Age)) +
  geom_boxplot(fill = "skyblue") +
  labs(title = "Distribución de Edad por Cluster", x = "Cluster", y = "Edad") +
  theme_minimal()

ggplot(df, aes(x = factor(cluster_k), y = Credit.amount)) +
  geom_boxplot(fill = "salmon") +
  labs(title = "Distribución del Monto de Crédito por Cluster", x = "Cluster", y = "Monto de Crédito") +
  theme_minimal()

ggplot(df, aes(x = factor(cluster_k), y = Duration)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Duración del Crédito por Cluster", x = "Cluster", y = "Duración (meses)") +
  theme_minimal()

sexo_cluster <- df %>%
  group_by(cluster_k, Sex) %>%
  summarise(count = n()) %>%
  mutate(freq = count / sum(count))

ggplot(sexo_cluster, aes(x = factor(cluster_k), y = freq, fill = Sex)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Proporción Sexo por Cluster", x = "Cluster", y = "Frecuencia") +
  theme_minimal()



``` 
Clúster 1 Jóvenes con empleo calificado y pocos ahorros
Este grupo se caracteriza por una edad promedio baja y una duración de crédito relativamente alta. Está compuesto mayoritariamente por mujeres, aunque también hay hombres. Predominan los empleos calificados y todas las personas arriendan vivienda. Los niveles de ahorro son reducidos y no suelen contar con productos financieros sólidos. Los créditos se destinan principalmente a la compra de automóviles, muebles y equipos. Son personas jóvenes, activas laboralmente, que usan el crédito para consumo, pero aún no han consolidado una base financiera fuerte.

Clúster 2  Mujeres propietarias con perfil financiero intermedio
Este grupo está compuesto exclusivamente por mujeres, con una edad intermedia y una duración de crédito similar a la del Clúster 1. Predomina la vivienda propia y los trabajos calificados. Los niveles de ahorro son moderados, aunque algunas aún presentan bajos saldos en cuentas corrientes. Solicitan créditos principalmente para muebles, automóviles y educación. Representan a mujeres financieramente activas con cierta estabilidad, que utilizan el crédito para mejorar su calidad de vida y educación.

Clúster 3 Hombres profesionalizados con buen respaldo financiero
Este grupo está conformado exclusivamente por hombres, con una edad media-alta y duración de crédito elevada. Todos tienen empleos altamente calificados y la mayoría son propietarios de vivienda. Su perfil financiero es sólido, con buena distribución entre cuentas de ahorro y cuentas corrientes. Utilizan el crédito principalmente para la compra de automóviles y muebles. Son hombres con empleo formal, educación alta y finanzas equilibradas, que usan el crédito para consumo planeado.

Clúster 4 Hombres trabajadores con enfoque empresarial y bajo ahorro
Este grupo está conformado por hombres con la mayor edad promedio entre los clústeres y plazos de crédito altos. Tienen empleos calificados y la mayoría posee vivienda propia. A pesar de su estabilidad laboral y habitacional, presentan bajos niveles de ahorro. El crédito se utiliza mayormente con fines empresariales y también para la compra de muebles y equipos. Representan a hombres trabajadores, posiblemente autónomos o emprendedores, con orientación a la inversión, pero baja liquidez.

Clúster 5 Hombres de perfil vulnerable con empleo informal y poca estabilidad
Este grupo está compuesto por hombres de edad media-alta, con la menor duración de crédito. Tienen empleos no calificados o inestables y viven en condiciones habitacionales precarias. Aunque la mayoría tiene cuentas de ahorro, estas suelen tener bajos saldos. El crédito se destina principalmente al consumo, como automóviles, muebles y educación. Representan a hombres con menor estabilidad laboral y financiera, que acceden a créditos a pesar de su alto riesgo crediticio.

